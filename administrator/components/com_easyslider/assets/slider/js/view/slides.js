void function(exports,$,_,Backbone){exports.JSNES_SlideView=Backbone.ItemView.extend({tagName:"DIV",className:"jsn-es-slide flex-flexible flex flex-layout flex-vertical",template:"#slideview-template",events:{"selectablestart .jsn-es-canvas-wrapper":"onSelectableStart","selectableselected .jsn-es-canvas-wrapper":"onSelectableSelected","selectableunselected .jsn-es-canvas-wrapper":"onSelectableDeselected","click .slide-preview-btn-enter":"enterPreviewMode","click .slide-preview-btn-leave":"leavePreviewMode","click .slide-preview-btn-play":"resumePreviewAnimation","click .slide-preview-btn-pause":"pausePreviewAnimation"},constructor:function JSNES_SlideView(){Backbone.ItemView.apply(this,arguments)},initialize:function(){this.isPreviewMode=false;this.uriPrefix=$(".jsn-es-app").attr("data-uri");this.transition=this.model.get("transition");this.items=this.model.get("items");this.renderPreviewAnimationFrame=_.bind(this.renderPreviewAnimationFrame,this);this.updateSelection=_.debounce(this.updateSelection)},ready:function(){this.sliderView=this.superView.superView;this.render();this.canvasView=this.attachView(new JSNES_CanvasView({collection:this.items}),".jsn-es-canvas");this.layersView=this.attachView(new JSNES_LayersView({collection:this.items}),".jsn-es-layers");this.timelineSliderView=this.attachView(new JSNES_TimelineSliderView({model:this.model}),".jsn-es-timeline-slider");this.listenTo(this.model,"change:backgroundPosition",this.updateImage);this.listenTo(this.model,"change:backgroundSize",this.updateImage);this.listenTo(this.model,"change:backgroundColor",this.updateImage);this.listenTo(this.model.get("backgroundImage"),"change",this.updateImage);this.listenTo(this.model,"change:active",this.updateSelection);this.listenTo(this.items,"add",this.updateSelection);this.listenTo(this.items,"remove",this.updateSelection);this.listenTo(this.items,"reset",this.updateSelection);this.listenTo(this.items,"change:selected",this.updateSelection);this.listenTo(this.model.get("transition"),"change:delay",function(){this.model.items.invoke("trigger","slide:change:delay")});$(window).resize(_.bind(this.onWindowResize,this));this.$(".jsn-es-canvas-background-wrapper").selectable({filter:".jsn-es-canvas .jsn-es-item:not(.jsn-es-item-locked):not(.invisible:not(.ui-selected))"});this.updateCSS();this.updateImage();this.updateSelection();this.sliderView.undoManager.register(this.model,this.model.get("items"));this.on("before:remove",function(){this.sliderView.undoManager.unregister(this.model,this.model.get("items"))})},onSelectableStart:function(e,ui){$(":focus").blur()},onSelectableSelected:function(e,ui){$(ui.selected).trigger("select")},onSelectableDeselected:function(e,ui){$(ui.unselected).trigger("deselect")},onWindowResize:function(){this.model.get("active")&&_(this.layersView.subViews).invoke("update")},updateCSS:function(){var sliderView=this.sliderView;var fullWidth=sliderView.model.get("fullWidth");var fullHeight=sliderView.model.get("fullHeight");var width=sliderView.model.getOuterWidth();var height=sliderView.model.get("height");var containerWidth=sliderView.model.getWidth();var containerHeight=sliderView.model.getHeight();var $ruler=this.$(".jsn-es-canvas-ruler.top");var $rulerBottom=this.$(".jsn-es-canvas-ruler.bottom");var $wrapper=this.$(".jsn-es-canvas-wrapper");var $bgWrapper=this.$(".jsn-es-canvas-background-wrapper");var $background=this.$(".jsn-es-canvas-background");var $preview=this.$(".jsn-es-canvas-preview");var $behind=this.$(".jsn-es-canvas-behind");var $canvas=this.$(".jsn-es-canvas");$background.css({width:width,minWidth:containerWidth,height:height||containerHeight});$preview.css({width:containerWidth,height:containerHeight});$behind.css({width:containerWidth,height:containerHeight});$canvas.css({width:containerWidth,height:containerHeight});$ruler.css({minWidth:$background.width(),backgroundPosition:$canvas.offset().left-$wrapper.offset().left+"px 10px"});$rulerBottom.css({minWidth:$background.width(),backgroundPosition:$canvas.offset().left-$wrapper.offset().left+"px -20px"});$wrapper.add($bgWrapper).height(Math.max($background.height(),300));if(this.$el.is(".hidden"))return;var pos=$canvas.position();var outWidth=$background.width();var outHeight=$background.height();var inWidth=$canvas.width();var inHeight=$canvas.height();var clipPolygon="polygon("+"0px 0px,"+""+(pos.left+inWidth)+"px 0px,"+""+Math.floor(pos.left+inWidth)+"px "+pos.top+"px,"+""+Math.ceil(pos.left)+"px "+pos.top+"px,"+""+Math.ceil(pos.left)+"px "+(pos.top+inHeight)+"px,"+""+Math.floor(pos.left+inWidth)+"px "+(pos.top+inHeight)+"px,"+""+Math.floor(pos.left+inWidth)+"px 0px,"+""+outWidth+"px 0px,"+""+outWidth+"px "+outHeight+"px,"+"0px "+outHeight+"px)";this.$(".jsn-es-canvas-mask").css({"-webkit-clip-path":clipPolygon,"-moz-clip-path":clipPolygon,"-ms-clip-path":clipPolygon,"-o-clip-path":clipPolygon,"clip-path":clipPolygon})},updateImage:function(){if(!this.model.get("backgroundImage.url"))return this.$(".jsn-es-canvas-background").css({background:this.model.get("backgroundColor")});var bgURL=this.model.get("backgroundImage.type")=="extend"?this.model.get("backgroundImage.url"):_.joinPath(this.uriPrefix,this.model.get("backgroundImage.url"));this.$(".jsn-es-canvas-background").css("background-image",this.model.get("backgroundImage.url")?"url("+bgURL+")":"").css(this.model.pick("backgroundPosition","backgroundSize","backgroundColor"));return this},updateSelection:function(){var selected=this.items.where({selected:true});var active=this.model.get("active");if(active){this.$el.removeClass("hidden");this.timelineSliderView.render();_(this.layersView.subViews).invoke("updateLayerCSS");_(this.canvasView.subViews).invoke("updateCSS");this.updateCSS()}else{this.$el.addClass("hidden")}if(selected.length){var inStarts=selected.map(function(item){return typeof item.inStart!="undefined"?item.inStart:item.get("build.inStart")});var outEnds=selected.map(function(item){return typeof item.outEnd!="undefined"?item.outEnd:item.get("build.outEnd")});var min=Math.min.apply(null,inStarts);var max=Math.max.apply(null,outEnds);this.timelineSliderView.$range.show();this.timelineSliderView.setTimeRange(min,max)}else{this.timelineSliderView.$range[this.isPreviewMode?"show":"hide"]();this.timelineSliderView.resetTimeRange()}this.sliderView.resetInspectorState()},enterPreviewMode:function(){if(this.isPreviewMode)return;var minTime=this.timelineSliderView.getMinTime();this.sliderView.$el.addClass("preview-mode");this.$(".slide-preview-btn-enter").addClass("hidden");this.$(".slide-preview-btn-leave").removeClass("hidden");this.$(".jsn-es-item.hidden").removeClass("hidden");_(this.canvasView.subViews).invoke("enterPreviewMode");this.isPreviewMode=true;this.previewAnimationFrames=0;this.previewAnimationStart=_.now()-minTime;this.timelineSliderView.$range.show();this.playPreviewAnimation()},leavePreviewMode:function(){this.isPreviewMode=false;this.sliderView.$el.removeClass("preview-mode");this.$(".slide-preview-btn-leave").addClass("hidden");this.$(".slide-preview-btn-enter").removeClass("hidden");this.$(".slide-preview-btn-play").addClass("hidden");this.$(".slide-preview-btn-pause").addClass("hidden");_(this.canvasView.subViews).invoke("leavePreviewMode");window.cancelAnimationFrame(this.previewAnimationFrameID);if(!this.items.where({selected:true}).length)this.timelineSliderView.$range.hide()},playPreviewAnimation:function(){this.previewAnimationPlaying=true;this.renderPreviewAnimationFrame();this.$(".slide-preview-btn-play").addClass("hidden");this.$(".slide-preview-btn-pause").removeClass("hidden");_(this.canvasView.subViews).invoke("renderPreviewFrame",0)},pausePreviewAnimation:function(){if(!this.previewAnimationPlaying)return;this.previewAnimationPlaying=false;window.cancelAnimationFrame(this.previewAnimationFrameID);this.previewAnimationPauseTime=_.now();this.$(".slide-preview-btn-pause").addClass("hidden");this.$(".slide-preview-btn-play").removeClass("hidden")},resumePreviewAnimation:function(){if(this.previewAnimationPlaying)return;this.previewAnimationStart+=_.now()-this.previewAnimationPauseTime;this.playPreviewAnimation()},setPreviewAnimationTime:function(time){var now=_.now();this.previewAnimationStart=now-time;this.previewAnimationPauseTime=now;_(this.canvasView.subViews).invoke("renderPreviewFrame",time)},renderPreviewAnimationFrame:function(){var now=_.now();var $track=this.timelineSliderView.$track;var minTime=this.timelineSliderView.getMinTime();var maxTime=this.timelineSliderView.getMaxTime();var lapsed=now-this.previewAnimationStart;this.previewAnimationFrames++;if(lapsed<minTime){this.previewAnimationStart=now-minTime}$track.slider("value",lapsed);_(this.canvasView.subViews).invoke("renderPreviewFrame",lapsed);if(lapsed>=maxTime){var minTime=this.timelineSliderView.getMinTime();var frameRate=Math.round(maxTime/this.previewAnimationFrames);this.previewAnimationStart=now-minTime;this.previewAnimationFrames=0;_(this.canvasView.subViews).invoke("renderPreviewFrame",minTime);$track.slider("value",minTime)}this.previewAnimationFrameID=window.requestAnimationFrame(this.renderPreviewAnimationFrame)}});exports.JSNES_SlidesView=Backbone.CollectionView.extend({itemView:exports.JSNES_SlideView});exports.JSNES_TimelineSliderView=Backbone.View.extend({events:{"mousedown .slide-track":"updateTimeGuideLine","slidestart .slider-track":"onTrackSlideStart","slide .slider-track":"onTrackSliding","slidechange .slider-track":"onTrackSlideChange","slidestop .slider-track":"onTrackSlideStop","slidestart .slider-range":"onRangeSlideStart","slide .slider-range":"onRangeSliding","slidechange .slider-range":"onRangeSlideChange","slidestop .slider-range":"onRangeSlideStop","click .increase-time":"increaseTime","click .decrease-time":"decreaseTime"},initialize:function(){this.model.durationStep=1e3;this.model.durationMin=1e3;this.model.duration=this.model.get("transition.delay");this.model.currentTime=this.model.get("currentTime");this.model.rangeStartTime=0;this.model.rangeEndTime=this.model.duration},ready:function(){this.$el.disableSelection();this.$ruler=this.$(".slider-ruler");this.$rulerSVG=this.$(".slider-ruler svg");this.$track=this.$(".slider-track");this.$range=this.$(".slider-range");this.$handle=this.$(".slider-track-handle");this.$guide=this.superView.$(".slider-track-handle-guide");this.$track.get(0).slide=null;this.$range.get(0).slide=null;this.$track.slider({min:0,step:1,value:this.model.currentTime,max:this.model.duration});this.$range.slider({min:0,step:100,range:true,values:[0,this.model.duration],max:this.model.duration});this.listenTo(this.model.get("transition"),"change:delay",this.changeDurationHandler);this.listenTo(this.model.get("items"),"change",_.debounce(this.updateTimeGuideLine));$(window).on("resize",_.bind(this.render,this));this.render()},render:function(){this.updateTimeGuideLine();this.renderRuler()},renderRuler:function(){var content="";var width=this.$track.width();var height=this.$track.height();var duration=this.model.get("transition.delay")/1e3;var gridWidth=width/duration;var subGridWidth=gridWidth/10;this.$rulerSVG.attr("width",width+50).attr("height",height);var i=0;while(i<duration+1){var left=Math.floor(i*gridWidth);var value=i<10?i.toFixed(1):i.toFixed(0);content+='<text x="'+left+'" y="20" dx="0" dy="0">'+value+"</text>";content+='<line class="grid-line" x1="'+left+'" y1="0" x2="'+left+'" y2="7" />';content+='<line class="grid-line" x1="'+left+'" y1="25" x2="'+left+'" y2="35" />';if(i<duration)_(9).times(function(s){var subGridLeft=left+Math.floor((s+1)*subGridWidth);if((s+1)%5==0&&duration<20)content+='<line class="sub-grid-line" x1="'+subGridLeft+'" y1="20" x2="'+subGridLeft+'" y2="35" />';else if(duration<10)content+='<line class="sub-grid-line" x1="'+subGridLeft+'" y1="28" x2="'+subGridLeft+'" y2="35" />'});i++}this.$rulerSVG.html(content)},changeDurationHandler:function(){var rangeValues=this.$range.slider("values");this.model.duration=this.model.get("transition.delay");this.$track.slider("option","max",this.model.duration);this.$range.slider("option","max",this.model.duration);_.defer(_.bind(function(){this.$range.slider("option","values",rangeValues)},this));this.render()},increaseTime:function(){var delay=this.model.get("transition.delay");var newDelay=delay%this.model.durationStep==0?delay+this.model.durationStep:Math.ceil(delay/this.model.durationStep)*this.model.durationStep;this.model.set("transition.delay",newDelay)},decreaseTime:function(){var delay=this.model.get("transition.delay");if(delay<=this.model.durationMin)return;var newDelay=delay%this.model.durationStep==0?delay-this.model.durationStep:Math.floor(delay/this.model.durationStep)*this.model.durationStep;this.model.set("transition.delay",newDelay)},updateRangeSliderData:function(ui){this.model.rangeStartTime=ui.values[0];this.model.rangeEndTime=ui.values[1]},getCurrentTime:function(){return this.$(".slider-track").slider("value")},getMinTime:function(){return this.$(".slider-range").slider("values")[0]},getMaxTime:function(){return this.$(".slider-range").slider("values")[1]},setMinTime:function(value){return this.$(".slider-range").slider("values",[value,this.getMaxTime()])},setMaxTime:function(value){return this.$(".slider-range").slider("values",[this.getMinTime(),value])},resetTimeRange:function(){return this.$(".slider-range").slider("values",[0,this.model.duration])},setTimeRange:function(from,to){return this.$(".slider-range").slider("values",[from,to])},onTrackSlideStart:function(e,ui){this.updateTrackSliderData(ui);if(this.superView.isPreviewMode&&this.superView.previewAnimationPlaying){this.superView.pausePreviewAnimation();this.superView.setPreviewAnimationTime(this.getCurrentTime());this.previewTemporaryPause=true}},onTrackSliding:function(e,ui){this.updateTrackSliderData(ui);if(this.superView.isPreviewMode){this.superView.previewAnimationPlaying||this.superView.setPreviewAnimationTime(this.getCurrentTime());return}},onTrackSlideStop:function(e,ui){this.updateTrackSliderData(ui);this.model.set({currentTime:this.getCurrentTime()});if(this.superView.isPreviewMode){if(!this.superView.previewAnimationPlaying&this.previewTemporaryPause){this.superView.resumePreviewAnimation();this.previewTemporaryPause=false}}},onTrackSlideChange:function(e,ui){this.updateTrackSliderData(ui);this.model.set("currentTime",ui.value,{silent:true})},updateTrackSliderData:function(ui){this.model.currentTime=ui.value;this.model.trigger("preview:currentTime")},onRangeSlideStart:function(e,ui){this.updateRangeSliderData(ui)},onRangeSliding:function(e,ui){this.updateRangeSliderData(ui)},onRangeSlideStop:function(e,ui){this.updateRangeSliderData(ui)},onRangeSlideChange:function(e,ui){this.updateRangeSliderData(ui)},updateTimeGuideLine:function(ui){this.$guide.height(this.superView.layersView.$el.height()+20)}})}(this,JSNES_jQuery,JSNES_Underscore,JSNES_Backbone);