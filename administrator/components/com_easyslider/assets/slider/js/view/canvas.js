void function(exports,$,_,Backbone){ENTER=13,ESC=27;exports.JSNES_ItemView=Backbone.ItemView.extend({constructor:function JSNES_ItemView(){Backbone.ItemView.apply(this,arguments)},ajaxURL:JSNES_CONFIG.URL.AJAX_UPLOAD_IMAGE,tagName:"DIV",className:"jsn-es-item",template:"#itemview-template",events:{select:"select",deselect:"deselect","position:change":"savePosition",mousedown:"onMouseDown",dragstart:function(e,ui){var zoom=this.sliderView.model.get("zoom");this.lastPosition={left:ui.position.left/zoom,top:ui.position.top/zoom}},drag:function(e,ui){var zoom=this.sliderView.model.get("zoom");ui.position.left/=zoom;ui.position.top/=zoom;if(this.lastPosition){var delta={left:ui.position.left-this.lastPosition.left,top:ui.position.top-this.lastPosition.top};this.$el.siblings(".jsn-es-item.ui-selected").each(function(){var pos=$(this).position();pos.left+=delta.left;pos.top+=delta.top;$(this).css(pos)})}this.lastPosition={left:ui.position.left,top:ui.position.top}},dragstop:function(){this.$el.siblings(".jsn-es-item.ui-selected").trigger("position:change");this.savePosition()},resizestart:function(e,ui){this.saveTextContent()},resize:function(e,ui){e.stopPropagation();var origin=this.model.getOrigin();var deltaWidth=ui.size.width-ui.originalSize.width;var deltaHeight=ui.size.height-ui.originalSize.height;switch(origin[0]){case 0:case 1:this.$el.width(ui.size.width);break;case.5:this.$el.width(ui.size.width+=deltaWidth);break}switch(origin[1]){case 0:case 1:this.$el.height(ui.size.height);break;case.5:this.$el.height(ui.size.height+=deltaHeight);break}if(!this.model.getStyle("height"))this.$el.height(this.$container.outerHeight());this.updateOriginCSS()},resizestop:function(e,ui){this.updateOriginCSS();this.savePosition()},"dragstart .text-editor":function(e,ui){e.stopPropagation()},"drag .text-editor":function(e,ui){e.stopPropagation()},"dragend .text-editor":function(e,ui){e.stopPropagation()},"drag .item-origin":function(e,ui){e.stopPropagation();var width=this.$el.width();var height=this.$el.height();var gridX=width/2;var gridY=height/2;ui.position.left=Math.round(ui.position.left/gridX)*gridX;ui.position.top=Math.round(ui.position.top/gridY)*gridY},"dragstop .item-origin":function(e,ui){e.stopPropagation();var pos=this.$el.position();this.$el.css({left:pos.left+(ui.position.left-ui.originalPosition.left)+"px",top:pos.top+(ui.position.top-ui.originalPosition.top)+"px"});this.saveOrigin();this.savePosition()},dblclick:function(e){switch(this.model.get("type")){case"text":case"html":this.enterTextEditor(e);break;case"image":break}},"focus .item-container .text-editor":function(){this.focusTextEditor()},"blur .item-container .text-editor":function(){this.leaveTextEditor()},"move:item":function(e,options){var distance=options.shift?10:1;var pos=this.$el.position();switch(options.keyCode){case 38:this.$el.css("top",pos.top-distance+"px");break;case 40:this.$el.css("top",pos.top+distance+"px");break;case 37:this.$el.css("left",pos.left-distance+"px");break;case 39:this.$el.css("left",pos.left+distance+"px");break}this.savePosition()},"mousedown .item-container .text-editor":function(e){!this.$el.is(".item-edit-mode")||e.stopPropagation()},"keydown .item-container .text-editor":function(e){e.stopPropagation();if(this.model.get("type")=="text"){if(e.keyCode==ENTER){}else if(e.keyCode==ESC){this.pressESC();e.preventDefault()}}},"keyup .item-container .text-editor":function(e){this.updateOriginCSS()}},initialize:function(){this.render();this.isTextFocused=false;var uri=window.location.pathname;this.uriPrefix=$(".jsn-es-app").attr("data-uri");this.hasHeight=this.model.getStyle("height")?true:false;Object.defineProperties(this,{sliderView:{get:function(){return this.superView.superView.superView.superView}},slideView:{get:function(){return this.superView.superView}},aspectRatio:{get:function(){return this.model.get("type")=="image"&&this.model.get("image.type")!="placeholder"?true:false}},resizeHandles:{get:function(){switch(this.model.get("type")){case"text":case"html":return this.hasHeight?"all":"e,w";default:return"all"}}}})},ready:function(){var type=this.model.get("type");this.$container=this.$(".item-container");this.$preview=this.$(".preview-container");this.$el.prependTo(this.superView.el).attr("tabindex",1).draggable({distance:5,snap:".jsn-es-canvas,.jsn-es-item",snapTolerance:10,grid:[5,5]});this.$(".item-origin").draggable({containment:"parent",cursor:"move"});this.resizable();switch(type){case"text":var mode=Medium.inlineRichMode;var paragraph="p";var outerLevel=[];var innerLevel=["a","b","u","i","img","strong","span"];this.$editor=this.$(".item-container .text-editor");switch(this.model.get("textType")){case"list":mode=Medium.richMode;paragraph="li";outerLevel=["li"];break;case"paragraph":mode=Medium.richMode;paragraph="p";outerLevel=["h1","h2","h3","h4","h5","h6"];break}!this.model.getStyle("fontFamily")||this.sliderView.fontsManager.loadFont(this.model.getStyle("fontFamily"));this.mediumEditor=new Medium({element:this.$editor.get(0),mode:mode,autoHR:false,pasteAsText:true,tags:{"break":"br",horizontalRule:"hr",paragraph:paragraph,outerLevel:outerLevel,innerLevel:innerLevel},attributes:["style","class"]});break;case"html":!this.model.getStyle("fontFamily")||this.sliderView.fontsManager.loadFont(this.model.getStyle("fontFamily"));this.mediumEditor=new Medium({element:this.$(".item-container .text-editor").get(0),mode:Medium.richMode,tags:null,attributes:{remove:null}});break;case"image":this.listenTo(this.model.get("image"),"change:url",function(){this.updateImage({change:true})});break;case"video":this.listenTo(this.model.get("video"),"change:url",this.changeVideoURL);break}this.model.set("index",this.$el.index());this.listenTo(this.model,"change:index",this.updateZIndex);this.listenTo(this.model.get("style"),"change",this.updateCSS);this.listenTo(this.model.get("style_M"),"change",this.updateCSS);this.listenTo(this.model.get("style_T"),"change",this.updateCSS);this.listenTo(this.model,"change:selected",this.updateSelected);this.listenTo(this.model,"change:lock",this.updateLock);this.listenTo(this.model,"change:show",this.updateVisibility);this.listenTo(this.model,"change:lock",this.updateLock);this.listenTo(this.model,"change:content",this.updateContent);this.listenTo(this.model,"preview",this.previewChange);this.listenTo(this.model,"change:in:out:time",this.updateVisibility);this.listenTo(this.slideView.model,"preview:currentTime",this.updateVisibility);this.listenTo(this.sliderView.model,"change:zoom",this.update);this.listenTo(this.sliderView.model,"change:responsiveEditMode",this.update);this.update()},resizable:function(){var type=this.model.get("type");this.$el.resizable().resizable("destroy").resizable({distance:5,handles:this.resizeHandles,snap:".jsn-es-canvas,.jsn-es-item",snapTolerance:10,aspectRatio:this.aspectRatio,grid:[5,5]})},updateZIndex:function(){var countItem=this.superView.subViews.length;this.$el.css({"z-index":countItem-parseInt(this.model.get("index"))})},previewChange:function(key,value){if(key.match(/^style\.(.*)$/))this.$(".item-container").css(key.match(/^style\.(.*)$/)[1],value)},isPercentValue:function(value){if(typeof value!=="string")return false;return value.match(/.*%/)?true:false},select:function(){this.model.set("selected",true);this.sliderView.$lastSelectedItem=this.el},deselect:function(){this.model.set("selected",false)},onMouseDown:function(e){$(":focus").blur();this.$el.focus();if((e.metaKey||e.ctrlKey)&&this.model.get("selected"))this.deselect();else{!e.metaKey&&!e.ctrlKey&&!this.model.get("selected")&&this.$el.siblings(".ui-selected").trigger("deselect");this.select()}},saveTextContent:function(){if(this.model.get("type")=="text"||this.model.get("type")=="html")this.model.set("content",this.mediumEditor.value());return this},pressESC:function(){if(this.model.get("type")=="text"){this.$el.draggable("enable")}this.$el.trigger("deselect")},updateContent:function(){if(this.model.get("type")=="text"){this.$el.addClass("text-item");this.mediumEditor.value(this.model.get("content"))}else if(this.model.get("type")=="html"){this.$el.addClass("html-item");this.mediumEditor.value(this.model.get("content"))}this.updateOriginCSS()},renderItem:function(){if(this.model.get("type")=="text"){this.$el.addClass("text-item");this.mediumEditor.value(this.model.get("content"))}else if(this.model.get("type")=="html"){this.$el.addClass("html-item");this.mediumEditor.value(this.model.get("content"))}else if(this.model.get("type")=="image"){if(typeof this.model.get("image")!=="undefined"&&!this.$image){this.$image=$("<img>").appendTo(this.$(".item-container"));this.updateImage()}}else if(this.model.get("type")=="video"){log(this.model.get("video.type"));if(this.model.get("video.type")=="youtube")this.renderVideoYoutube();if(this.model.get("video.type")=="local")this.renderVideoLocal();if(this.model.get("video.type")=="vimeo")this.renderVideoVimeo()}this.model.get("lock")==true?this.$el.addClass("jsn-es-item-locked"):this.$el.removeClass("jsn-es-item-locked");if(this.model.get("type")=="html"){this.$(".text-editor-toolbar").position({my:"bottom",at:"top",of:this.el})}},renderVideoLocal:function(){var videoObj=this.model.get("video").toJSON();var mimeType="";if(videoObj.url.indexOf(".mp4")>=0)mimeType="mp4";if(videoObj.url.indexOf(".ogg")>=0)mimeType="ogg";var html='<div class="thumb" ><div class="play-icon"><i class="fa fa-play"></i></div></div>';this.$(".item-container").html(html)},renderVideoYoutube:function(){var videoObj=this.model.get("video").toJSON();if(typeof videoObj.thumb==="undefined"||typeof videoObj.title==="undefined"){var data=this.changeYoutubeLink()}else{var id=videoObj.url.match(/[?&]?v=(.*)&?/)?videoObj.url.match(/[?&]?v=(.*)&?/)[1]:videoObj.url.match(/youtu\.be\/(.*)/)[1];var html='<div class="thumb" style="background-image: url('+videoObj.thumb+')"><div class="play-icon"><i class="fa fa-play"></i></div></div>';html+='<div class="video-player hidden '+videoObj.type+'" id="'+_.uniqueId("jsn-es-player")+'" data-id="'+id+'" width="100%" height="100%"></div>';this.$(".item-container").html(html)}},renderVideoVimeo:function(){var videoObj=this.model.get("video").toJSON();var id=videoObj.url.match(/[?&]?vimeo\.com.*\/(\d+)/)?videoObj.url.match(/[?&]?vimeo\.com.*\/(\d+)/)[1]:"12345678";this.model.get("video").set({id:id},{silent:true});var html='<div class="thumb"><div class="play-icon"><i class="fa fa-play"></i></div></div>';html+='<div class="video-player hidden '+videoObj.type+'" id="'+_.uniqueId("jsn-es-player")+'" data-id="'+id+'" width="100%" height="100%"></div>';this.$(".item-container").html(html)},changeVideoURL:function(){if(this.model.get("video.type")=="youtube"){this.changeYoutubeLink()}else if(this.model.get("video.type")=="vimeo"){this.renderVideoVimeo()}},changeYoutubeLink:function(){var view=this;var videoObj=this.model.get("video").toJSON();var IDRegex=/(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|\/user\/\S+|\/ytscreeningroom\?v=|\/sandalsResorts#\w\/\w\/.*\/))([^\/&]{10,12})/;if(videoObj.type!="youtube")return;if(typeof videoObj.url!=="undefined"&&videoObj.url!=""){var id=videoObj.url.match(IDRegex);if(!id)return;id=id[1];var thumbURL="https://i.ytimg.com/vi/"+id+"/hqdefault.jpg";this.$(".video-player").attr("data-id",id);var html='<div class="thumb" style="background-image: url('+thumbURL+')"><div class="play-icon"><i class="fa fa-play"></i></div></div>';view.$(".item-container").html(html);view.model.get("video").set({thumb:thumbURL},{silent:true})}},lock:function(){this.undelegateEvents();this.$el.draggable("disable").resizable("disable").removeClass("ui-state-disabled").addClass("jsn-es-item-locked");this.$(".es-text-editor").attr("contenteditable",false);this.model.set("selected",false)},unLock:function(){this.delegateEvents(this.events);this.$el.draggable("enable").resizable("enable").removeClass("jsn-es-item-locked");this.$(".es-text-editor").attr("contenteditable",true)},isVisible:function(){var timelineVisible=this.model.get("build.inStart")<=this.slideView.model.currentTime&&this.model.get("build.outEnd")>=this.slideView.model.currentTime;return this.model.get("show")&&timelineVisible&&this.model.getStyle("visibility")=="visible"?true:false},update:function(){this.updateVisibility();this.updateSelected();this.updateLock();this.renderItem();this.updateCSS();if(this.model.get("type")=="image")this.updateImage()},updateCSS:function(){this.updateVisibility();log("Updating item CSS");this.el.style.cssText=null;this.$el.css("z-index",this.model.collection.length-parseInt(this.model.get("index"))).css(_(this.model.getStyle()).pick("height","width","top","left","visibility"));this.$(".item-container").get(0).style.cssText=null;this.$(".item-container").css(_(this.model.getStyle()).omit("height","width","top","left","visibility"));this.updateContent();this.updateOriginCSS();var hasHeight=this.model.getStyle("height")?true:false;if(this.hasHeight!=hasHeight){this.hasHeight=hasHeight;this.resizable()}return this},updateOriginCSS:function(){var origin=this.model.getOrigin();var offsetX=this.$el.outerWidth()*origin[0];var offsetY=this.$el.outerHeight()*origin[1];this.$el.css(_.pick(this.model.getStyle(),"top","left")).css({marginLeft:-offsetX+"px",marginTop:-offsetY+"px"});this.$(".item-origin").css({top:offsetY+"px",left:offsetX+"px"})},updateSelected:function(){this.$el[this.model.get("selected")?"addClass":"removeClass"]("ui-selected")},updateVisibility:function(){this.$el[this.isVisible()?"removeClass":"addClass"]("invisible")},updateLock:function(){if(typeof this.model.get("lock")!=="undefined"&&this.model.get("lock"))this.lock();else this.unLock()},updateImage:function(options){var view=this;var src=this.model.get("image.url");options||(options={});if(!src){view.$el.addClass("image-placeholder");view.$(".item-container img").removeAttr("src");view.model.get("image").set({type:"placeholder",url:"",original:null},{silent:true});view.resizable();return}if(src==view.$(".item-container img").attr("src"))return;var img=new Image;var URIRegex=/^(http|https)?:?\/\/([^\/]+)(\/.*)/;view.$el.removeClass("image-placeholder").addClass("image-loading");view.resizable();src.match(URIRegex)||(src=_.joinPath(this.uriPrefix,src));img.onerror=function(e){alert("Failed to load image from source: "+view.model.get("image.url"));view.$el.addClass("image-placeholder");view.$el.removeClass("image-loading");view.$(".item-container img").removeAttr("src")};img.onload=function(){var currentWidth=view.$el.width();var currentHeight=view.$el.height();var currentRatio=currentWidth/currentHeight;var newWidth=this.width;var newHeight=this.height;var newRatio=newWidth/newHeight;var changedSize=false;var newImage=!view.model.get("image.original");view.$el.removeClass("image-loading");view.$(".item-container img").attr("src",src);view.model.get("image").set({original:{width:newWidth,height:newHeight}},{silent:true});if(options.change){if(newWidth>currentWidth){newWidth=currentWidth;newHeight=currentWidth/newRatio}changedSize=true}if(newImage){var canvasWidth=view.superView.$el.width();var canvasHeight=view.superView.$el.height();if(newWidth>canvasWidth){newWidth=canvasWidth;newHeight=canvasWidth/newRatio}if(newHeight>canvasHeight){newHeight=canvasHeight;newWidth=canvasHeight*newRatio}view.$el.width(newWidth).height(newHeight);changedSize=true}if(changedSize){view.model.set("style",{width:newWidth+"px",height:newHeight+"px"},{silent:true});view.savePosition();view.updateCSS();view.updateOriginCSS()}};img.src=src;return},saveOrigin:function(){var origin=this.$(".item-origin").position();var width=this.$el.width();var height=this.$el.height();var originX=Math.round(origin.left/width/.5)*.5;var originY=Math.round(origin.top/height/.5)*.5;originX<0&&(originX=0);originX>1&&(originX=1);originY<0&&(originY=0);originY>1&&(originY=1);this.model.set("origin",[originX,originY].join(","));return this},savePosition:function(){var pos=this.$el.position();var origin=this.$(".item-origin").position();var width=this.$el.width();var height=this.$el.height();var zoom=this.sliderView.model.get("zoom");var parentWidth=this.superView.$el.width();var parentHeight=this.superView.$el.height();var left=this.isPercentValue(this.model.getStyle("left"))?(pos.left/zoom/parentWidth*100).toFixed(2)+"%":pos.left/zoom+"px";var top=this.isPercentValue(this.model.getStyle("top"))?(pos.top/zoom/parentHeight*100).toFixed(2)+"%":pos.top/zoom+"px";var newWidth=this.isPercentValue(this.model.getStyle("width"))?(width/parentWidth*100).toFixed(2)+"%":width+"px";var newHeight=this.isPercentValue(this.model.getStyle("height"))?(height/parentHeight*100).toFixed(2)+"%":height+"px";var styles={width:this.model.getStyle("width")?newWidth:undefined,height:this.model.getStyle("height")?newHeight:undefined,top:top,left:left};this.model.setStyle(styles)},enterTextEditor:function(e){if(this.mediumEditor){this.sliderView.activeMediumEditor=this.mediumEditor;if(this.$el.is(".item-edit-mode"))return;this.$el.addClass("item-edit-mode");this.$el.draggable("disable");this.mediumEditor.focus();this.mediumEditor.lastSelection?this.mediumEditor.selection.restoreSelection(this.mediumEditor.lastSelection):this.mediumEditor.select()}return this},leaveTextEditor:function(){this.saveTextContent();this.mediumEditor.lastSelection=this.mediumEditor.selection.saveSelection();this.isTextFocused=false;this.$el.draggable("enable").removeClass("item-edit-mode").deselectText();return this},focusTextEditor:function(){this.isTextFocused=true;return this},enterPreviewMode:function(){this.isPreviewMode=true;this.$el.resizable("disable");this.$el.removeClass("hidden");this.$preview.empty().append(this.$container.clone()).css("opacity",0)},leavePreviewMode:function(){this.isPreviewMode=false;this.$el.resizable("enable");this.$preview.empty();this.updateVisibility()},renderPreviewFrame:function(time){if(!this.isPreviewMode||!this.isVisible())return;var build=this.model.get("build").toJSON();if(time<build.inStart){this.$preview.JSNES_TransformOrigin(build.inTransform.origin).JSNES_Transform(build.inTransform)}else if(time>=build.inStart&&time<=build.inEnd){var lapsed=time-build.inStart;var duration=build.inEnd-build.inStart;this.$preview.JSNES_TransformOrigin(build.inTransform.origin).JSNES_TransformTween(build.inTransform,{},lapsed,duration,build.inEasing)}else if(time>build.inEnd&&time<build.outStart){this.$preview.JSNES_Transform({})}else if(build.outStart==build.outEnd){this.$preview.JSNES_Transform({})}else if(time>=build.outStart&&time<=build.outEnd){this.$preview.JSNES_TransformOrigin(build.outTransform.origin).JSNES_TransformTween({},build.outTransform,time-build.outStart,build.outEnd-build.outStart,build.outEasing)}else if(time>build.outEnd){this.$preview.JSNES_TransformOrigin(build.outTransform.origin).JSNES_Transform(build.outTransform)}},renderPreviewFrameEffect:function(type,build,time){if(this.model.get("type")=="text"){var delay=100;var $children=this.$preview.css("opacity",1).find(".text-editor").children();var durationChanged=delay*$children.length;$children.each(function(i){var start=build.inStart+i*delay;var end=build.inEnd-(durationChanged-i*delay);if(time>=start&&time<=end){var lapsed=time-start;var duration=end-start;$(this).JSNES_TransformOrigin(build.outTransform.origin).JSNES_TransformTween(build.inTransform,{},lapsed,duration,build.inEasing)}})}else{var lapsed=time-build.inStart;var duration=build.inEnd-build.inStart;switch(type){case"in":this.$preview.JSNES_TransformOrigin(build.outTransform.origin).JSNES_TransformTween(build.inTransform,{},lapsed,duration,build.inEasing);break}}}});exports.JSNES_CanvasView=Backbone.CollectionView.extend({itemView:exports.JSNES_ItemView,constructor:function JSNES_CanvasView(){Backbone.CollectionView.apply(this,arguments)},ready:function(){this.listenTo(this.collection,"change",this.changeHandler);this.listenTo(this.collection,"add",this.changeHandler);this.listenTo(this.collection,"remove",this.changeHandler);this.changeHandler=_.debounce(this.changeHandler)},changeHandler:function(){this.superView.superView.superView.trigger("change")}});exports.JSNES_SubItemsView=Backbone.CollectionView.extend({constructor:function JSNES_SubItemsView(){Backbone.CollectionView.apply(this,arguments)},itemView:exports.JSNES_ItemView.extend({constructor:function JSNES_SubItemView(){JSNES_ItemView.apply(this,arguments);this.isSubItem=true},className:"jsn-es-item jsn-es-sub-item"})})}(this,JSNES_jQuery,JSNES_Underscore,JSNES_Backbone);