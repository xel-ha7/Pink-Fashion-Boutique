void function(exports,$,_,Backbone){exports.JSNES_SliderView=Backbone.View.extend({constructor:function JSNES_SLiderView(){Backbone.View.apply(this,arguments)},events:{dragenter:"preventDefault",dragover:"preventDefault",drop:"preventDefault","click .add-slide":"addSlideCheck","click .undo-btn":"undo","click .redo-btn":"redo","click .add-item-text":"addNewTextItem","click .add-item-html":"addNewHTMLItem","click .add-item-image":"addNewImageItem","click .add-item-image-from-media":"addNewImageItemFromMedia","click .add-item-image-by-url":"addNewImageItemByURL","click .add-item-video-url":"addNewVideoItemURL","click .add-item-video-youtube":"addNewVideoItemYoutube","click .add-item-video-vimeo":"addNewVideoItemVimeo","click .btn-cancel-save":"cancelSave","click .btn-save-data":"saveDataAjax","click .btn-save-data-and-close":"saveDataAndClose","click .btn-save-item":"saveItemToTemplate","click .btn-save-slide":"saveSlideToTemplate","click .btn-copy-item":"copyItem","click .btn-paste-item":"pasteItem","click .btn-settings":"clickSettingsBtnHandler","click .btn-align-items":"alignSelectedItems",'click .btn-group[data-toggle="jsn-es-buttons"] .btn':"toggleButtonGroupHandler",'click .btn[data-toggle="jsn-es-button"]':"toggleButtonHandler","change .canvas-zoom":"changeCanvasZoom",'mouseenter *[data-tooltip="true"]':"showTooltip",'mouseleave *[data-tooltip="true"]':"hideTooltip",'mousedown *[data-tooltip="true"]':"hideTooltip","change .slider-title":"changeTitleHandler",contextMenu:"preventDefault"},initialize:function(options){this.clipboard=null;this.activeMediumEditor=null;this.history=[];this.$saveTarget=$(options.saveTarget);this.$lastSelectedItem=null;this.model||(this.model=new JSNES_SliderData);try{var data=JSNES_SliderData.validate(JSON.parse(this.$saveTarget.val()))}catch(e){var data={}}this.model.set(data);this.slides=this.model.get("slides");this.checkNoSlide();if($('input[name="jform[slider_id]"]').val()==""){this.createNewSlider()}this.fontsManager=new JSNES_FontsManager(JSNES_FontsList);this.undoManager=new Backbone.UndoManager({maximumStackLength:50});this.changeHandler=_.debounce(this.changeHandler)},ready:function(){this.itemInspectorView=this.attachView(new JSNES_ItemInspectorView,".jsn-es-item-inspector");this.slideInspectorView=this.attachView(new JSNES_SlideInspectorView,".jsn-es-slide-inspector");this.sliderToolbarView=this.attachView(new JSNES_ToolbarView({model:this.model}),".jsn-es-slider-toolbar");this.slideToolbarView=this.attachView(new JSNES_ToolbarView({model:this.model}),".jsn-es-slide-toolbar");this.sliderConfigView=this.attachView(new JSNES_SliderConfigView({model:this.model}),".jsn-es-config");this.thumbsView=this.attachView(new JSNES_ThumbsView({collection:this.slides}),".jsn-es-thumbs");this.slidesView=this.attachView(new JSNES_SlidesView({collection:this.slides}),".jsn-es-slides");this.animationSelectorView=this.attachView(new JSNES_AnimationSelectorView,".jsn-es-animation-selector");this.animationSelectorView.render();$(window).keydown(_.bind(this.keydownHandler,this));$(window).keyup(_.bind(this.keyupHandler,this));$(window).keypress(_.bind(this.keypressHandler,this));$(window).resize(_.bind(this.resizeHandler,this));this.$(".jsn-es-toolbar").disableSelection();if(typeof this.model.get("zoom")!=="undefined"){this.$(".canvas-zoom").val(this.model.get("zoom"))}this.delay(function(){this.listenTo(this.model,"change:size",this.setSliderSize);this.listenTo(this.model,"change:size",this.resizeHandler);this.listenTo(this.model,"change:responsiveEditMode",this.setSliderSize);this.listenTo(this.model,"change:responsiveEditMode",this.resizeHandler);this.listenTo(this.model,"change:zoom",this.updateZoomCSS);this.listenTo(this.slides,"remove",this.checkNoSlide);this.listenTo(this.model.get("settings"),"change",this.changeHandler);this.listenTo(this.model,"change",this.changeHandler);this.on("change",this.changeHandler);this.undoManager.startTracking();$(".jsn-es-loading-screen .loader").addClass("paused").fadeOut("slow",function(){$(".jsn-es-loading-screen").fadeOut("slow",function(){$(this).remove()})});this.resizeHandler();this.setSliderSize();log("App :: ready")},500)},preventDefault:function(e){e.preventDefault()},changeTitleHandler:function(){var title=this.$(".jsn-es-title-wrapper .slider-title").val().replace(/\s+/g,"");if(title!=""){this.trigger("change")}else{this.trigger("change")}},changeHandler:function(){this.$(".btn-save-data,.btn-save-data-and-close").removeAttr("disabled");this.model.setUsedFonts();this.dataChanged=true;log("Slider :: data change")},resizeHandler:function(){var slidesHeight=this.$(".jsn-es-slides").outerHeight();var canvasHeight=this.$(".jsn-es-slide:not(.hidden) .jsn-es-canvas-wrapper").outerHeight();var toolbarHeight=this.$(".jsn-es-slide-toolbar").outerHeight();if(canvasHeight)this.$(".jsn-es-inspector-panel, .jsn-es-thumbs-panel").height(canvasHeight+toolbarHeight);else this.$(".jsn-es-inspector-panel, .jsn-es-thumbs-panel").height(slidesHeight+toolbarHeight);this.setSliderSize()},keydownHandler:function(e){if($(e.target).is("input,select,textarea")&&!e.metaKey&&!e.ctrlKey)return;switch(e.keyCode){case 9:e.preventDefault();this.$el.toggleClass("jsn-es-minimal");this.resizeHandler();break;case 27:e.preventDefault();_.each(this.slidesView.subViews,function(slideView){if(slideView.model.get("active")&&slideView.isPreviewMode){slideView.leavePreviewMode()}});break;case 32:e.preventDefault();_.each(this.slidesView.subViews,function(slideView){if(slideView.model.get("active")){if(!slideView.isPreviewMode)slideView.enterPreviewMode();else if(slideView.previewAnimationPlaying)slideView.pausePreviewAnimation();else slideView.resumePreviewAnimation()}});break;case 37:case 38:case 39:case 40:log("move key");this.$(".jsn-es-canvas .jsn-es-item.ui-selected").trigger("move:item",{keyCode:e.keyCode,shift:e.shiftKey});e.preventDefault();break;case 8:case 46:e.preventDefault();this.deleteSelectedItems();break;case 90:if((e.metaKey||e.ctrlKey)&&e.shiftKey){e.preventDefault();this.redo()}else if(e.metaKey||e.ctrlKey){e.preventDefault();this.undo()}break;case 83:if(e.metaKey||e.ctrlKey){e.preventDefault();this.$(".btn-save-data").click()}break}if(e.keyCode==67&&(e.metaKey||e.ctrlKey)&&!$(e.target).is("input")){this.copyItem();e.preventDefault()}if(e.keyCode==86&&(e.metaKey||e.ctrlKey)&&!$(e.target).is("input")){this.pasteItem();e.preventDefault()}},keyupHandler:function(e){switch(e.keyCode){case 32:if($(e.target).is("body")){this.$(".jsn-es-canvas-panner").addClass("hidden");e.preventDefault()}break}},keypressHandler:function(e){},deleteSelectedItems:function(){var selected=this.getSelectedItems();if(!selected.length)return;if(confirm(JSNES_TEXT.DELETE_ITEM_CONFIRM)){_(selected).invoke("destroy")}},clickSettingsBtnHandler:function(e){this.sliderConfigView.show(e.currentTarget);this.sliderConfigView.$el.position({my:"center top+5",at:"center bottom",of:e.currentTarget})},alignSelectedItems:function(e){var alignment=$(e.currentTarget).attr("data-alignment");var $selectedItems=this.$(".jsn-es-canvas .jsn-es-item.ui-selected");$selectedItems.alignItems(alignment,$selectedItems.length==1?this.$(".jsn-es-slide:not(.hidden) .jsn-es-canvas"):this.$lastSelectedItem).trigger("position:change")},toggleButtonGroupHandler:function(e){var $el=$(e.currentTarget);if(!$el.hasClass("active")){$el.addClass("active").siblings().removeClass("active");$el.parent().trigger("change")}},toggleButtonHandler:function(e){var $el=$(e.currentTarget);$el.toggleClass("active").trigger("change")},getActiveSlide:function(){return this.slides.findWhere({active:true})},getSelectedItems:function(){var activeSlide=this.slides.findWhere({active:true});return activeSlide?activeSlide.get("items").where({selected:true}):[]},resetInspectorState:function(){var activeSlide=this.getActiveSlide();var selectedItems=activeSlide.get("items").where({selected:true});if(selectedItems.length){this.itemInspectorView.release();while(selectedItems.length)this.itemInspectorView.inspect(selectedItems.shift());this.showItemTools()}else{this.slideInspectorView.inspect(activeSlide);this.hideItemTools()}return this},cancelSave:function(e){window.location=JSNES_CONFIG.URL.SLIDERS_LIST_VIEW},checkNoSlide:function(){this.slides.length||this.slides.add({active:true})},showTooltip:function(e){if(e.which)return;var placement=$(e.currentTarget).attr("data-placement")||"auto";$(e.currentTarget).tooltip({container:"body",placement:placement,trigger:"manual"}).tooltip("show")},hideTooltip:function(e){$(".tooltip").remove()},undo:function(){this.undoManager.undo(true);this.resetInspectorState();return this},redo:function(){this.undoManager.redo(true);this.resetInspectorState();return this},addSlideCheck:function(){if(typeof this.addSlide=="undefined")return;this.addSlide.apply(this,arguments);this.defer(function(){this.$(".jsn-es-thumb:not(.add-slide)").last().trigger("click")})},addNewItem:function(type,data){var activeSlide=this.getActiveSlide();activeSlide.get("items").invoke("set",{selected:false});activeSlide.get("items").add(_({type:type,selected:true,build:{outStart:activeSlide.get("transition.delay"),outEnd:activeSlide.get("transition.delay")}}).deepExtend(JSNES_ItemDefaults[type],data));this.resetInspectorState()},addNewTextItem:function(e){return this.addNewItem($(e.currentTarget).attr("data-type")||"text")},addNewImageItem:function(){return this.addNewItem("image",{style:{width:"200px",height:"150px"}})},addNewImageItemFromMedia:function(){$.JSNES_MediaSelector(_.bind(function(url){this.addNewItem("image",{image:{url:url}})},this));return this},addNewImageItemByURL:function(){$.JSNES_Prompt("URL to your image file",_.bind(function(url){this.addNewItem("image",{image:{url:url}})},this));return this},addNewVideoItemURL:function(){$.JSNES_Prompt("URL to your video file",_.bind(function(url){this.addNewItem("video",{video:{url:url}})},this));return this},addNewVideoItemYoutube:function(){$.JSNES_Prompt("Enter Youtube video URL",_.bind(function(url){this.addNewItem("video",{video:{url:url,type:"youtube"}})},this));return this},addNewVideoItemVimeo:function(){$.JSNES_Prompt("Enter Vimeo video URL",_.bind(function(url){this.addNewItem("video",{video:{url:url,type:"vimeo"}})},this));return this},addNewHTMLItem:function(){return this.addNewItem("html")},setSliderSize:function(){log("set slider size");_(this.slidesView.subViews).invoke("updateCSS");return this},saveDataAndClose:function(){this.saveDataAjax()},saveDataAjax:function(){this.$(".btn-save-data").addClass("saving");var slider_id=$('#jform_slider_id-container input[name="jform[slider_id]"]').val();if(slider_id!=""){this.updateSliderData(slider_id)}else{this.createNewSlider()}},updateSliderData:function(slider_id){var self=this;var slider_title=this.$(".slider-title").val();var slider_data=JSON.stringify(this.model.toJSON());var data={slider_id:slider_id,slider_title:slider_title,slider_data:slider_data};$.ajax({url:JSNES_CONFIG.URL.AJAX_UPDATE_SLIDER_DATA,type:"POST",dataType:"jsonp",data:data,complete:function(data){var response=JSON.parse(data.responseText);self.ajaxSaveCompleteHandler(response);if(typeof response.message!=="undefined"){var type=typeof response.error!=="undefined"&&!response.error?"success":"danger";log(response);$.bootstrapGrowl(response.message,{type:type})}}})},ajaxSaveCompleteHandler:function(response){this.$(".btn-save-data,.btn-save-data-and-close").attr("disabled","disabled").removeClass("saving");this.dataChanged=false},createNewSlider:function(){var self=this;var slider_title=this.$(".slider-title").val();var slider_data=JSON.stringify(this.model.toJSON());var data={slider_title:slider_title,slider_data:slider_data};$.ajax({url:JSNES_CONFIG.URL.AJAX_CREATE_NEW_SLIDER,type:"POST",dataType:"jsonp",data:data,complete:function(data){var response=JSON.parse(data.responseText);self.ajaxSaveCompleteHandler(response);var newHref=window.location.href+"&slider_id="+response.slider_id;$('#jform_slider_id-container input[name="jform[slider_id]"]').val(response.slider_id);history.pushState({},"Create new slider",newHref)}})},updateZoomCSS:function(){return this.resizeHandler();var zoom=this.model.get("zoom");if(zoom&&typeof zoom!=="undefined"){this.$(".canvas-zoom").val(zoom);zoom=parseFloat(zoom);var width=parseInt(this.model.getWidth());var height=parseInt(this.model.getHeight());var fullWidth=this.model.get("fullWidth");var fullHeight=this.model.get("fullHeight");var newWidth=width*zoom;var newHeight=height*zoom;this.$(".jsn-es-canvas-background").css({width:newWidth+"px",height:newHeight+"px",marginTop:newHeight/-2+"px",marginLeft:newWidth/-2+"px"});this.$(".jsn-es-canvas,.jsn-es-canvas-preview").css({width:width+"px",height:height+"px",transform:"scale("+zoom+")",marginTop:height/-2+"px",marginLeft:width/-2+"px"});this.$(".jsn-es-canvas .jsn-es-item .ui-resizable-handle").css("transform",zoom>=1?"":"scale("+1/zoom+")");this.$(".jsn-es-canvas-wrapper").height(newHeight+100)}},changeCanvasZoom:function(){var zoom=this.$(".canvas-zoom").val();this.model.set("zoom",zoom);log("change canvas zoom")},copyItem:function(){this.clipboard=this.getSelectedItems().map(function(model){return model.toJSON()});this.$(".btn-paste-item").removeClass("disabled")},pasteItem:function(){var activeSlide=this.slides.findWhere({active:true});if(activeSlide&&this.clipboard&&this.clipboard.length){_(activeSlide.get("items").where({selected:true})).invoke("set","selected",false);var lastStartTime=this.clipboard.sort(function(a,b){if(a.build.inStart<b.build.inStart)return 1;else return-1})[0].build.inStart;if(activeSlide.get("currentTime")<lastStartTime&&lastStartTime<activeSlide.get("transition.delay")){activeSlide.set("currentTime",lastStartTime)}var pasteItems=_(this.clipboard).map(function(oldItem){var item=$.extend(true,{},oldItem);var build=item.build;var maxTime=activeSlide.get("transition.delay");var diff=0;if(build.inStart>maxTime){diff=maxTime-build.inStart;build.inStart=0;build.inEnd+=diff;build.outStart+=diff;build.outEnd+=diff}if(build.inEnd>maxTime){build.inEnd=maxTime}if(build.outStart>maxTime){build.outStart=maxTime}if(build.outEnd>maxTime){build.outEnd=maxTime}return item});this.defer(function(){activeSlide.get("items").add(pasteItems);this.resetInspectorState()})}},showItemTools:function(){this.$(".btn.item-align-tools").removeClass("disabled");this.$(":not(.btn).item-align-tools").removeClass("hidden")},hideItemTools:function(){this.$(".btn.item-align-tools").addClass("disabled");this.$(":not(.btn).item-align-tools").addClass("hidden")}})}(this,JSNES_jQuery,JSNES_Underscore,JSNES_Backbone);