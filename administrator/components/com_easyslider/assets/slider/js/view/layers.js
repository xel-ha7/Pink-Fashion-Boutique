void function(exports,$,_,Backbone){exports.JSNES_LayerView=Backbone.ItemView.extend({constructor:function JSNES_LayerView(){Backbone.ItemView.apply(this,arguments)},tagName:"DIV",className:"jsn-es-layer flex flex-layout",template:"#layerview-template",isStickToEnd:false,events:{select:"selectLayer",deselect:"deselectLayer","click .duplicate-layer":"duplicateLayer","click .enable-layer":"toggleItem","click .lock-layer":"toggleLockLayer","click .delete-layer":function(){if(confirm(JSNES_TEXT.DELETE_ITEM_CONFIRM)){this.model.collection.remove(this.model);this.superView.superView.$(".jsn-es-canvas").trigger("mousedown")}},mousedown:function(e){if($(e.target).is(".layer-toggle-button,.lock-layer"))return;this.mouseDownHandler(e)},"mousedown .timeline-duration":function(e){e.stopPropagation();this.mouseDownHandler(e);if($(e.target).is(".ui-resizable-handle"))return;_.defer(_.bind(function(){this.slideView.updateSelection()},this),0)},"mousedown .timeline-in":function(e){this.sliderView.itemInspectorView.$('a[href="#item-effect"],.build-in-fx-tab-toggle').trigger("click");this.lastTimelineInMouseDown=_.now();e.stopPropagation();this.mouseDownHandler(e);this.slideView.updateSelection();_.defer(_.bind(function(){this.slideView.timelineSliderView.setTimeRange(this.model.get("build.inStart")-this.previewTimeOffset,this.model.get("build.inEnd")+this.previewTimeOffset)},this),0)},"mousedown .timeline-out":function(e){this.sliderView.itemInspectorView.$('a[href="#item-effect"],.build-out-fx-tab-toggle').trigger("click");this.lastTimelineOutMouseDown=_.now();e.stopPropagation();this.mouseDownHandler(e);this.slideView.updateSelection();_.defer(_.bind(function(){this.slideView.timelineSliderView.setTimeRange(this.model.get("build.outStart")-this.previewTimeOffset,this.model.get("build.outEnd")+this.previewTimeOffset)},this),0)},"mouseleave .timeline-in,.timeline-out":function(e){this.lastTimelineInMouseDown=0;this.lastTimelineOutMouseDown=0},"mouseup .timeline-in":function(e){},"mouseup .timeline-out":function(e){},"dblclick .timeline-in":function(e){this.sliderView.animationSelectorView.select([this.model],"in",e.currentTarget)},"dblclick .timeline-out":function(e){this.sliderView.animationSelectorView.select([this.model],"out",e.currentTarget)},"keyup .layer-title":"saveTitle","keydown .layer-title":function(e){if(e.keyCode==ENTER||e.which==ENTER){e.preventDefault()}},"focus .layer-title":function(e){if(!this.model.get("lock")){this.defer(function(){$(e.currentTarget).select()})}},"blur .layer-title":"saveTitle"},initialize:function(){this.previewTimeOffset=0;this.render();this.update=_.debounce(this.update);this.updateSelected=_.debounce(this.updateSelected)},ready:function(){this.sliderView=this.superView.superView.superView.superView;this.slideView=this.superView.superView;var delay=this.slideView.model.get("transition.delay");if(this.model.get("build.outStart")==this.model.get("build.outEnd")&&this.model.get("build.outStart")==delay){this.model.stickToEnd=true}else{this.model.stickToEnd=false}var view=this;var isChecked=this.model.get("show");this.$("input.enable-layer").prop("checked",isChecked);this.$timeline=this.$(".layer-timeline");this.$(".timeline-duration").draggable({containment:"parent",axis:"x",distance:5,drag:function(e,ui){var step=view.getSnappingWidth();ui.position.left=Math.round(ui.position.left/step)*step;view.setBuildTransition(true);var timelineView=view.slideView.timelineSliderView;timelineView.setTimeRange(view.model.inStart-view.previewTimeOffset,view.model.outEnd+view.previewTimeOffset)},stop:function(){view.setBuildTransition();var timelineView=view.slideView.timelineSliderView;timelineView.setTimeRange(view.model.inStart-view.previewTimeOffset,view.model.outEnd+view.previewTimeOffset)}}).resizable({handles:"e,w",containment:"parent",minWidth:view.minDurationW||0,distance:5,start:function(e,ui){$(this).find("div .ui-resizable-handle").fadeOut();this.resizingHandle=$(e.originalEvent.target).is(".ui-resizable-w")?"w":"e"},resize:function(e,ui){var step=view.getSnappingWidth();ui.position.left=Math.round(ui.position.left/step)*step;ui.size.width=Math.round(ui.size.width/step)*step;if(ui.position.left>$(this).parent().width())ui.position.left=$(this).parent().width();var $out=$(this).find(".timeline-out");$out.css("left",ui.size.width-$out.outerWidth());var timelineView=view.slideView.timelineSliderView;var lastInStart=view.model.inStart;var lastOutEnd=view.model.outEnd;view.setBuildTransition(true);if(this.resizingHandle=="w"){timelineView.setMinTime(view.model.inStart-view.previewTimeOffset);if(timelineView.getMaxTime()!=lastOutEnd)timelineView.setMaxTime(view.model.inEnd+view.previewTimeOffset)}if(this.resizingHandle=="e"){timelineView.setMaxTime(view.model.outEnd+view.previewTimeOffset);if(timelineView.getMinTime()!=lastInStart)timelineView.setMinTime(view.model.outStart-view.previewTimeOffset)}},stop:function(e,ui){var step=view.getSnappingWidth();ui.position.left=Math.round(ui.position.left/step)*step;ui.size.width=Math.round(ui.size.width/step)*step;$(this).find("div .ui-resizable-handle").fadeIn();view.setBuildTransition()}});this.$(".timeline-in").resizable({maxWidth:view.maxInW,distance:5,minWidth:0,handles:"e",resize:function(e,ui){ui.size.width>11?$(this).removeClass("no-effect-in"):$(this).addClass("no-effect-in");ui.size.width>$(this).parent().width()-11?$(this).siblings(".timeline-out").find(".ui-resizable-handle").hide():$(this).siblings(".timeline-out").find(".ui-resizable-handle").show();var step=view.getSnappingWidth();ui.position.left=Math.round(ui.position.left/step)*step;ui.size.width=Math.round(ui.size.width/step)*step;var timelineView=view.slideView.timelineSliderView;view.setBuildTransition(true);timelineView.setMaxTime(view.model.inEnd+view.previewTimeOffset)},stop:function(e,ui){var step=view.getSnappingWidth();ui.position.left=Math.round(ui.position.left/step)*step;ui.size.width=Math.round(ui.size.width/step)*step;view.setBuildTransition()}});this.$(".timeline-out").resizable({distance:5,handles:"w",minWidth:0,maxWidth:view.maxOutW,resize:function(e,ui){ui.size.width>=0||(ui.position.left+=ui.size.width);ui.size.width>11?$(this).removeClass("no-effect-out"):$(this).addClass("no-effect-out");ui.size.width>$(this).parent().width()-11?$(this).siblings(".timeline-in").find(".ui-resizable-handle").hide():$(this).siblings(".timeline-in").find(".ui-resizable-handle").show();var step=view.getSnappingWidth();ui.position.left=Math.round(ui.position.left/step)*step;ui.size.width=Math.round(ui.size.width/step)*step;var timelineView=view.slideView.timelineSliderView;view.setBuildTransition(true);timelineView.setMinTime(view.model.outStart-view.previewTimeOffset)},stop:function(e,ui){var step=view.getSnappingWidth();ui.position.left=Math.round(ui.position.left/step)*step;ui.size.width=Math.round(ui.size.width/step)*step;view.setBuildTransition()}});this.build=this.model.get("build");this.listenTo(this.build,"change",this.updateBuildCSS);this.listenTo(this.model,"change:name",this.updateTitle);this.listenTo(this.model,"change:content",this.updateTitle);this.listenTo(this.model,"change:lock",this.updateLock);this.listenTo(this.model,"change:selected",this.updateSelected);this.listenTo(this.model,"check:selected",this.updateSelected);this.listenTo(this.model,"change:show",this.updateShow);this.listenTo(this.model,"slide:change:delay",this.updateBuildCSS);this.updateBuildCSS();this.updateShow();this.updateLock();this.updateSelected();this.updateTitle();$(window).resize(_.bind(view.updateLayerCSS,this));this.$el.addClass("layer-ready")},updateSelected:function(){this.$el[this.model.get("selected")==true?"addClass":"removeClass"]("selected");return this},updateTitle:function(){this.$(".layer-title").val(this.model.get("name")||$("<div>"+this.model.get("content")+"</div>").text())},updateShow:function(){var isChecked=this.model.get("show");this.$("input.enable-layer").prop("checked",isChecked);this.$(".enable-layer").attr("es-enable",this.model.get("show"))},updateBuildCSS:function(){var delay=this.slideView.model.get("transition.delay");var width=this.$(".layer-timeline").width();var grid=Math.round(100/delay*width);if(this.model.get("build.outStart")==this.model.get("build.outEnd")&&this.model.get("build.outStart")==delay){this.model.stickToEnd=true}else{this.model.stickToEnd=false}this.updateLayerCSS();this.$(".timeline-duration").resizable("option","minWidth",this.minDurationW);this.$(".timeline-in").resizable("option","maxWidth",this.maxInW);this.$(".timeline-out").resizable("option","maxWidth",this.maxOutW)},updateLock:function(){this.$(".lock-layer").attr("es-enable",this.model.get("lock"));this.$el[this.model.get("lock")?"addClass":"removeClass"]("jsn-es-locked")},update:function(){if(this._frozen)return log("View frozen and stopped updating");return this},updateIndex:function(){this.model.set("index",this.$el.index())},mouseDownHandler:function(e){if((e.metaKey||e.ctrlKey)&&this.model.get("selected"))this.deselectLayer();else{!e.metaKey&&!e.ctrlKey&&!this.model.get("selected")&&this.$el.siblings(".selected").trigger("deselect");this.selectLayer()}$("body").trigger("mousedown");this.sliderView.hideTooltip(e)},selectLayer:function(){this.model.set("selected",true)},deselectLayer:function(){this.model.set("selected",false)},saveTitle:function(e){var $editor=this.$(".layer-title");var value=$editor.val();if(value!=this.model.get("content"))this.model.set("name",value)},getSnappingWidth:function(){return this.$timeline.width()*(100/this.slideView.model.duration)},setBuildTransition:function(preview){var handleWidth=0;var A,B,C,D;var $duration=this.$(".timeline-duration"),$in=this.$(".timeline-in"),$out=this.$(".timeline-out");var totalTime=this.superView.superView.model.get("transition.delay");var timelineWidth=this.$(".layer-timeline").width();var ratio=(timelineWidth-handleWidth*4)/totalTime;A=$duration.position().left;B=$in.width()-handleWidth*2;C=$out.position().left-A-B-handleWidth*2;D=$out.width()-handleWidth*2;var offset=$duration.position().left/ratio;var inStart=A/ratio;var inEnd=(A+B)/ratio;var outStart=(A+B+C)/ratio+offset;var outEnd=(A+B+C+D)/ratio+offset;this.model.inStart=inStart=Math.round(inStart/100)*100;this.model.inEnd=inEnd=Math.round(inEnd/100)*100;this.model.outStart=outStart=Math.round(outStart/100)*100;this.model.outEnd=outEnd=Math.round(outEnd/100)*100;if(!preview)this.model.get("build").set({inStart:inStart,inEnd:inEnd,outStart:outStart,outEnd:outEnd})},duplicateLayer:function(){var model=this.model.toJSON();model.selected=true;model.lock=false;model.style.left+=10;model.style.top+=10;this.superView.collection.add(model)},toggleItem:function(){var show=!this.model.get("show");var selected=show&&this.model.get("selected")?true:false;this.model.set({show:show,selected:selected})},toggleLockLayer:function(){this.model.set("lock",!this.model.get("lock"))},updateLayerCSS:function(){if(this._frozen)return"Frozen";var handleWidth=0;var $in=this.$(".timeline-in"),$out=this.$(".timeline-out");var totalTime=this.superView.superView.model.get("transition.delay");var timelineWidth=this.$(".layer-timeline").width();var ratio=(timelineWidth-handleWidth*4)/totalTime;var build=this.model.get("build").attributes;var G,H,K,L;G=Math.round(build.inStart*ratio);H=Math.round(build.inEnd*ratio)+handleWidth*2-G;K=Math.round(build.outStart*ratio)+handleWidth*2;L=Math.round(build.outEnd*ratio)+handleWidth*4-K;this.$(".timeline-duration").css({left:G+"px",width:K+L-G+"px"});var renderEffectName=function(fade,effect){return"";return"Select "+'<span class="fa fa-caret-up"></span>';if(effect=="none")return fade?"fade":"none";return(fade?"fade-":"")+effect};$in.css({width:H+"px"}).find(".timeline-effect-name").html(this.model.get("build.inEffect"));$out.css({left:K-G+"px",width:L+"px"}).find(".timeline-effect-name").html(this.model.get("build.outEffect"));var inStart=this.model.get("build.inStart");var inEnd=this.model.get("build.inEnd");var outStart=this.model.get("build.outStart");var outEnd=this.model.get("build.outEnd");inStart==inEnd?this.$(".timeline-in").addClass("no-effect-in"):this.$(".timeline-in").removeClass("no-effect-in");outStart==outEnd?this.$(".timeline-out").addClass("no-effect-out"):this.$(".timeline-out").removeClass("no-effect-out");inEnd==outStart&&outStart==outEnd?this.$(".timeline-out .ui-resizable-w").hide():this.$(".timeline-out .ui-resizable-w").show();inEnd==outStart&&inStart==inEnd?this.$(".timeline-in .ui-resizable-e").hide():this.$(".timeline-in .ui-resizable-e").show();this.maxInW=K-G;this.maxOutW=K+L-H-G;this.minDurationW=L+H}});exports.JSNES_LayersView=Backbone.CollectionView.extend({itemView:JSNES_LayerView,constructor:function JSNES_LayersView(){Backbone.CollectionView.apply(this,arguments)},events:{resize:function(e){e.stopPropagation()},sortupdate:"updateIndex"},initialize:function(){this.on("freeze",function(){this.$el.hide()});this.on("unfreeze",function(){this.$el.show()});this.addQueueItems=_.debounce(this.addQueueItems)},ready:function(){this.$el.sortable({tolerance:"pointer",cancel:"input",handle:".drag-handle",cursor:"grabbing",axis:"y",revert:100})},reset:function(){this.empty();_(this.collection.toArray().reverse()).each(this.add,this);return this},add:function(model){this.queueItems.push(model);this.addQueueItems()},addQueueItems:function(){log("Layers View :: add",this.queueItems.length,"items");while(this.queueItems.length)this.prependView(new this.itemView({model:this.queueItems.shift()}));this.updateIndex()},updateIndex:function(){_(this.subViews).invoke("updateIndex")}})}(this,JSNES_jQuery,JSNES_Underscore,JSNES_Backbone);